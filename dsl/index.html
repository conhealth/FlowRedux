
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Kotlin Multiplatform library to create state machines">
      
      
        <link rel="canonical" href="https://freeletics.github.com/flowredux/dsl/">
      
      
        <meta name="author" content="Freeletics">
      
      <link rel="shortcut icon" href="../images/icon-freeletics.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.0.1">
    
    
      
        <title>DSL Guide - FlowRedux</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.38780c08.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.3f72e892.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
    
    
    
      
        
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
      <link rel="stylesheet" href="../css/app.css">
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="white">
      
  
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#dsl-guide" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://freeletics.github.com/flowredux/" title="FlowRedux" class="md-header-nav__button md-logo" aria-label="FlowRedux">
      
  <img src="../images/icon-freeletics.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      
        <div class="md-header-nav__ellipsis">
          <span class="md-header-nav__topic md-ellipsis">
            FlowRedux
          </span>
          <span class="md-header-nav__topic md-ellipsis">
            
              DSL Guide
            
          </span>
        </div>
      
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active">
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/freeletics/FlowRedux/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    FlowRedux
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://freeletics.github.com/flowredux/" title="FlowRedux" class="md-nav__button md-logo" aria-label="FlowRedux">
      
  <img src="../images/icon-freeletics.png" alt="logo">

    </a>
    FlowRedux
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/freeletics/FlowRedux/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    FlowRedux
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="FlowRedux" class="md-nav__link">
      FlowRedux
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../contributing/" title="Contributing" class="md-nav__link">
      Contributing
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        DSL Guide
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="./" title="DSL Guide" class="md-nav__link md-nav__link--active">
      DSL Guide
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#initial-state" class="md-nav__link">
    Initial State
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#changestate" class="md-nav__link">
    ChangeState
  </a>
  
    <nav class="md-nav" aria-label="ChangeState">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overridestatesnextstate-state" class="md-nav__link">
    OverrideState&lt;S&gt;(nextState : State)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mutatestatesubstate-state-reducer-currentstate-substate-state" class="md-nav__link">
    MutateState&lt;SubState, State&gt;( reducer: (currentState : SubState) -&gt; State )
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nostatechange" class="md-nav__link">
    NoStateChange
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#instatestate" class="md-nav__link">
    inState&lt;State&gt;
  </a>
  
    <nav class="md-nav" aria-label="inState&lt;State&gt;">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#onenter" class="md-nav__link">
    onEnter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#onaction" class="md-nav__link">
    on&lt;Action&gt;
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collectwhileinstate" class="md-nav__link">
    collectWhileInState()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#custom-condition-for-instate" class="md-nav__link">
    Custom condition for inState
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#collectwhileinanystate" class="md-nav__link">
    collectWhileInAnyState()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flatmappolicy" class="md-nav__link">
    FlatMapPolicy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practice" class="md-nav__link">
    Best Practice
  </a>
  
    <nav class="md-nav" aria-label="Best Practice">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-recommended-way" class="md-nav__link">
    The recommended way
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../flow_vs_FlowReduxStateMachine/" title="FlowReduxStateMachine vs .reduxStore()" class="md-nav__link">
      FlowReduxStateMachine vs .reduxStore()
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../multiplatform/" title="Multiplatform" class="md-nav__link">
      Multiplatform
    </a>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#initial-state" class="md-nav__link">
    Initial State
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#changestate" class="md-nav__link">
    ChangeState
  </a>
  
    <nav class="md-nav" aria-label="ChangeState">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#overridestatesnextstate-state" class="md-nav__link">
    OverrideState&lt;S&gt;(nextState : State)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mutatestatesubstate-state-reducer-currentstate-substate-state" class="md-nav__link">
    MutateState&lt;SubState, State&gt;( reducer: (currentState : SubState) -&gt; State )
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#nostatechange" class="md-nav__link">
    NoStateChange
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#instatestate" class="md-nav__link">
    inState&lt;State&gt;
  </a>
  
    <nav class="md-nav" aria-label="inState&lt;State&gt;">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#onenter" class="md-nav__link">
    onEnter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#onaction" class="md-nav__link">
    on&lt;Action&gt;
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#collectwhileinstate" class="md-nav__link">
    collectWhileInState()
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#custom-condition-for-instate" class="md-nav__link">
    Custom condition for inState
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#collectwhileinanystate" class="md-nav__link">
    collectWhileInAnyState()
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#flatmappolicy" class="md-nav__link">
    FlatMapPolicy
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#best-practice" class="md-nav__link">
    Best Practice
  </a>
  
    <nav class="md-nav" aria-label="Best Practice">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-recommended-way" class="md-nav__link">
    The recommended way
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/freeletics/FlowRedux/edit/master/docs/dsl.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="dsl-guide">DSL Guide<a class="headerlink" href="#dsl-guide" title="Permanent link">&para;</a></h1>
<p>FlowRedux provides a convenient DSL to describe your state machine. This page introduces you the DSL that you can use.</p>
<p>To do that we will stick with a simple example of loading a list of items from a web service. As you read this section
and more concepts of the DSL will be introduced we will extend this sample.</p>
<p>For now to get started, let&rsquo;s define the <code>States</code> our state machine has. As said before we load a list of items from a
web service and display that list. While loading the list we show a loading indicator on the screen and if an error
occurs we show an error message on the screen with a retry button.</p>
<p>This gives us the following states:</p>
<div class="highlight"><pre><span></span><code><span class="k">sealed</span> <span class="k">class</span> <span class="nc">State</span> <span class="p">{</span>

    <span class="c1">// Shows a loading indicator on screen</span>
    <span class="k">object</span> <span class="nc">LoadingState</span> <span class="p">:</span> <span class="n">State</span><span class="p">()</span>

    <span class="c1">// List of items loaded successfully, show it on screen</span>
    <span class="k">data</span> <span class="k">class</span> <span class="nc">ShowContentState</span><span class="p">(</span><span class="k">val</span> <span class="py">items</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Item</span><span class="p">&gt;)</span> <span class="p">:</span> <span class="n">State</span><span class="p">()</span>

    <span class="c1">// Error while loading happened</span>
    <span class="k">data</span> <span class="k">class</span> <span class="nc">ErrorState</span><span class="p">(</span><span class="k">val</span> <span class="py">cause</span><span class="p">:</span> <span class="n">Throwable</span><span class="p">)</span> <span class="p">:</span> <span class="n">State</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<p>If we reached <code>ErrorState</code> we display an error message but also a button a user can click to retry loading the items.
This gives us the following <code>Actions</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">sealed</span> <span class="k">class</span> <span class="nc">Action</span> <span class="p">{</span>
    <span class="k">object</span> <span class="nc">RetryLoadingAction</span> <span class="p">:</span> <span class="n">Action</span><span class="p">()</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="initial-state">Initial State<a class="headerlink" href="#initial-state" title="Permanent link">&para;</a></h2>
<p>Every <code>FlowReduxStateMachine</code> needs an initial state. This is in which state the state machine starts. In our example we
start with the <code>LoadingState</code>.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyStateMachine</span><span class="p">(</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">httpClient</span><span class="p">:</span> <span class="n">HttpClient</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">FlowReduxStateMachine</span><span class="p">&lt;</span><span class="n">State</span><span class="p">,</span> <span class="n">Action</span><span class="p">&gt;(</span><span class="n">initialState</span> <span class="p">=</span> <span class="n">LoadingState</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">init</span> <span class="p">{</span>
        <span class="n">spec</span> <span class="p">{</span>
            <span class="c1">// will be filled in next section</span>
            <span class="p">...</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Please note the constructor parameter of <code>FlowReduxStateMachine(initialState = ...)</code>. This is how you define the initial
state of your state machine. Next, we already see that we need an <code>init {...}</code> block containing a <code>spec { ... }</code> block
inside. The <code>spec { ... }</code> block is actually where we write our DSL inside.</p>
<h2 id="changestate">ChangeState<a class="headerlink" href="#changestate" title="Permanent link">&para;</a></h2>
<p>One key concept of the FlowRedux DSL is that the return type of every function such as <code>onEnter</code>, <code>onAction</code>
and <code>collectWhileInState</code>
(we will learn about them later) is of type <code>ChangeState&lt;State&gt;</code>. For example:</p>
<div class="highlight"><pre><span></span><code><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">handleLoadingAction</span><span class="p">(</span><span class="n">stateSnapshot</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span> <span class="n">ChangeState</span><span class="p">&lt;</span><span class="n">State</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">items</span> <span class="p">=</span> <span class="n">loadItems</span><span class="p">()</span> <span class="c1">// suspend function</span>
    <span class="k">return</span> <span class="n">OverrideState</span><span class="p">(</span><span class="n">ShowContentState</span><span class="p">(</span><span class="n">items</span><span class="p">))</span> <span class="c1">// OverrideState extends from ChangeState. We will talk about it in 1 minutes.</span>
<span class="p">}</span>
</code></pre></div>

<p>As the name suggests <code>ChangeState&lt;State&gt;</code> is the way to tell the Redux store what the next state is or how to &ldquo;compute&rdquo;
the next state(often also called reduce state).
<code>ChangeState</code> is a sealed class. You never use <code>ChangeState</code> directly but only one of the subtypes. There are 3 subtypes
that cover different use cases:</p>
<ul>
<li><code>OverrideState&lt;S&gt;(nextState : State)</code></li>
<li><code>MutateState&lt;SubState, State&gt;( reducer: (currentState : SubState) -&gt; State )</code></li>
<li><code>NoStateChange</code></li>
</ul>
<p>Next, let&rsquo;s talk about these 3 types of <code>ChangeState</code> in detail.</p>
<h3 id="overridestatesnextstate-state"><code>OverrideState&lt;S&gt;(nextState : State)</code><a class="headerlink" href="#overridestatesnextstate-state" title="Permanent link">&para;</a></h3>
<p><code>OverrideState&lt;S&gt;(nextState : State)</code> is overriding the current state of your redux store to whatever you pass in as
parameter. By using <code>OverrideState</code> you basically say &ldquo;I don&rsquo;t care what the current state is, just set state to
whatever I give you&rdquo;. This is used if computing the next state is independent of current state. You literally override
the state regardless of what the current state is.</p>
<p>Usage:</p>
<div class="highlight"><pre><span></span><code><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">handleFooAction</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">Action</span><span class="p">,</span> <span class="n">stateSnapshot</span><span class="p">:</span> <span class="n">State</span><span class="p">):</span> <span class="n">ChangeState</span><span class="p">&lt;</span><span class="n">State</span><span class="p">&gt;</span> <span class="p">{</span>
    <span class="p">...</span>
    <span class="k">return</span> <span class="n">OverrideState</span><span class="p">(</span><span class="n">SomeOtherState</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="mutatestatesubstate-state-reducer-currentstate-substate-state"><code>MutateState&lt;SubState, State&gt;( reducer: (currentState : SubState) -&gt; State )</code><a class="headerlink" href="#mutatestatesubstate-state-reducer-currentstate-substate-state" title="Permanent link">&para;</a></h3>
<p><code>MutateState&lt;SubState, State&gt;( reducer: (currentState : SubState) -&gt; State )</code> is used if your next state computation is
based on the current state. Thus, <code>MutateState</code> expects a lambda block with signature <code>(State) -&gt; State</code>. This is a
so-called reducer function to compute the next state. You may wonder why <code>MutateState</code> takes such a lambda as
constructor parameter and not a new state instance as <code>OverrideState</code> does? The reason is that FlowRedux is an
asynchronous state machine meaning multiple coroutines can run in parallel and mutate state. Here is a very simple
example (we will discuss the exact details of the used DSL later in this documentat):</p>
<div class="highlight"><pre><span></span><code><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">createRandomItem</span><span class="p">():</span> <span class="n">Item</span> <span class="p">{</span>
    <span class="k">val</span> <span class="py">random</span> <span class="p">=</span> <span class="p">(</span><span class="m">0.</span><span class="p">.</span><span class="m">10</span><span class="p">).</span><span class="n">random</span><span class="p">()</span>
    <span class="n">delay</span><span class="p">(</span><span class="n">random</span> <span class="p">*</span> <span class="m">1000</span><span class="p">)</span> <span class="c1">// randomly wait for up to 10 seconds</span>
    <span class="k">return</span> <span class="n">Item</span><span class="p">(</span><span class="s">&quot;random $random&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="p">...</span>
<span class="c1">// DSL specs</span>
<span class="n">spec</span> <span class="p">{</span>
    <span class="n">inState</span><span class="p">&lt;</span><span class="n">ShowContent</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="n">on</span><span class="p">&lt;</span><span class="n">AddItemAction</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">action</span><span class="p">:</span> <span class="n">AddItemAction</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ShowContent</span> <span class="p">-&gt;</span>
            <span class="k">val</span> <span class="py">item</span><span class="p">:</span> <span class="n">Item</span> <span class="p">=</span> <span class="n">createRandomItem</span><span class="p">()</span>
            <span class="n">MutateState</span> <span class="p">{</span> <span class="n">currentState</span><span class="p">:</span> <span class="n">ShowContent</span> <span class="p">-&gt;</span> <span class="n">currentState</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">items</span> <span class="p">=</span> <span class="n">currentState</span><span class="p">.</span><span class="n">items</span> <span class="p">+</span> <span class="n">item</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>As you see <code>createRandomItem()</code> can take some time to return a value. Furthermore, every invocation
of <code>createRandomItem()</code> could take differently long to return a value. Let&rsquo;s take a look at the following scenario:
current state of our FlowRedux state machine is <code>ShowContent(items = listof( Item("1"), Item("2")))</code>. Next we
trigger <code>AddItemAction</code> 2 times very fast (within a few milliseconds) one after each other which eventually
triggers <code>createRandomItem()</code> 2 times. Let&rsquo;s assume the first invocation of <code>createRandomItem()</code> takes 6 seconds to
return new item, the second invocation takes 3 seconds. What is the expected state after this two <code>AddItemAction</code> are
handled? There should be 2 state changes: First <code>ShowContent(items = listof( Item("1"), Item("2"), Item("random 3")))</code>
and secondly <code>ShowContent(items = listof( Item("1"), Item("2"), Item("random 3"), Item("random 6")))</code>. This is exactly
what we get by using <code>MutateState</code>. If we use <code>OverrideState</code> or <code>MutateState</code> would not have a reducer lambda as
parameter then the code as follows:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// DSL specs</span>
<span class="n">spec</span> <span class="p">{</span>
    <span class="n">inState</span><span class="p">&lt;</span><span class="n">ShowContent</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="n">on</span><span class="p">&lt;</span><span class="n">AddItemAction</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">action</span><span class="p">:</span> <span class="n">AddItemAction</span><span class="p">,</span> <span class="n">state</span><span class="p">:</span> <span class="n">ShowContent</span> <span class="p">-&gt;</span>
            <span class="k">val</span> <span class="py">item</span><span class="p">:</span> <span class="n">Item</span> <span class="p">=</span> <span class="n">createRandomItem</span><span class="p">()</span>
            <span class="c1">// WRONG: don&#39;t do that. This is just to demo an issue (see explanation bellow).</span>
            <span class="n">OverrideState</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">items</span> <span class="p">=</span> <span class="n">currentState</span><span class="p">.</span><span class="n">items</span> <span class="p">+</span> <span class="n">item</span><span class="p">))</span> <span class="c1">// or MutateState( state.copy(items = currentState.items + item) )</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>and state transition are as follows:
First <code>ShowContent(items = listof( Item("1"), Item("2"), Item("random 3")))</code> and
secondly <code>ShowContent(items = listof( Item("1"), Item("2"), Item("random 6")))</code>. How comes that the second state
transition produces <code>ShowContent</code> without <code>Item("random 3")</code>? The reson is that we are accessing the state
parameter <code>on&lt;AddItemAction&gt; { action: AddItemAction, state: ShowContent -&gt; ... }</code>
and that this state parameter is actually only a snapshot of the state when <code>on&lt;AddItemAction&gt;</code> did trigger. In our
example this is always capturing the following state <code>ShowContent(items = listof( Item("1"), Item("2") ) )</code>
The state could have changed before reaching <code>return OverrideState(...)</code>. Well, that is exactly what is happening.
Remember, within a few milliseconds we dispatch 2 times <code>AddItemAction</code> and then it takes 3 and 6 seconds
for <code>createRandomItem()</code> to return. Thus, the state transition actually overrides the first state transition. This is
why you must use <code>MutateState</code> with a reducer lambda in such cases when you want to change some properties of the
current state (but not transition to an entirely different state like <code>ErrorState</code>) to handle cases properly where
parallel execution could have changed the state in the meantime.</p>
<h3 id="nostatechange"><code>NoStateChange</code><a class="headerlink" href="#nostatechange" title="Permanent link">&para;</a></h3>
<p><code>NoStateChange</code> is the last option that you have for <code>ChangeState</code> and it should be only used very carefully to cover
some cases that could not be covered otherwise.
<code>NoStateChange</code> is an <code>object</code>, thus a singleton. Basically what <code>NoStateChange</code> is good for is to tell that you
actually dont want to do a state transition. When you need this? Again, there should be only very limited use case
for <code>NoStateChange</code> but most likely if there is really no other way then at runtime check for some conditions and then
either trigger <code>OverrideState</code>, <code>MutateState</code> or <code>NoChangeState</code> if state should really not change (but you really only
know that at runtime only, but this is usually an indicator that you should rethink your state modelling to avoid having
this issue).</p>
<p>Usage:</p>
<div class="highlight"><pre><span></span><code><span class="n">suspend</span> <span class="k">fun</span> <span class="nf">handleFooAction</span><span class="p">(</span><span class="n">action</span><span class="p">:</span> <span class="n">Action</span><span class="p">,</span> <span class="n">stateSnapshot</span><span class="p">:</span> <span class="n">State</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="k">data</span> <span class="p">==</span> <span class="s">&quot;foo&quot;</span> <span class="p">&amp;&amp;</span> <span class="n">stateSnapshot</span><span class="p">.</span><span class="k">data</span> <span class="p">==</span> <span class="s">&quot;bar&quot;</span><span class="p">)</span> <span class="c1">// just demo some random condition check</span>
        <span class="k">return</span> <span class="n">NoStateChange</span>

    <span class="p">...</span>
    <span class="k">return</span> <span class="n">OverrideState</span><span class="p">(</span><span class="n">OtherState</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="instatestate">inState<code>&lt;State&gt;</code><a class="headerlink" href="#instatestate" title="Permanent link">&para;</a></h2>
<p>The first concept we learn is <code>inState</code></p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyStateMachine</span><span class="p">(</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">httpClient</span><span class="p">:</span> <span class="n">HttpClient</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">FlowReduxStateMachine</span><span class="p">&lt;</span><span class="n">State</span><span class="p">,</span> <span class="n">Action</span><span class="p">&gt;(</span><span class="n">initialState</span> <span class="p">=</span> <span class="n">LoadingState</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">init</span> <span class="p">{</span>
        <span class="n">spec</span> <span class="p">{</span>
            <span class="n">inState</span><span class="p">&lt;</span><span class="n">LoadingState</span><span class="p">&gt;</span> <span class="p">{</span>
                <span class="p">...</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Please note that <code>inState</code> itself doesn&rsquo;t do anything. All we did so far with <code>inState&lt;LoadingState&gt;</code> is set an entry
point. Next let&rsquo;s discuss what an <code>inState</code> can contain as triggers to actually &ldquo;do something&rdquo;:</p>
<ol>
<li><code>onEnter</code>: Triggers whenever we enter that state</li>
<li><code>on&lt;Action&gt;</code>: Triggers whenever we are in this state and the specified action is triggered from the outside by
   calling <code>FlowReduxStateMachine.dispatch(action)</code>.</li>
<li><code>collectWhileInState( flow )</code>: You can subscribe to any arbitrary <code>Flow</code> while your state machine is in that state.</li>
</ol>
<p>Let&rsquo;s go through them as we build our state machine.</p>
<h3 id="onenter">onEnter<a class="headerlink" href="#onenter" title="Permanent link">&para;</a></h3>
<p>What do we want to do when we enter the <code>LoadingState</code>? We want to do the http request, right? Let&rsquo;s do that by
extending our example:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyStateMachine</span><span class="p">(</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">httpClient</span><span class="p">:</span> <span class="n">HttpClient</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">FlowReduxStateMachine</span><span class="p">&lt;</span><span class="n">State</span><span class="p">,</span> <span class="n">Action</span><span class="p">&gt;(</span><span class="n">initialState</span> <span class="p">=</span> <span class="n">LoadingState</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">init</span> <span class="p">{</span>
        <span class="n">spec</span> <span class="p">{</span>
            <span class="n">inState</span><span class="p">&lt;</span><span class="n">LoadingState</span><span class="p">&gt;</span> <span class="p">{</span>
                <span class="n">onEnter</span> <span class="p">{</span> <span class="n">stateSnapshot</span><span class="p">:</span> <span class="n">LoadingState</span> <span class="p">-&gt;</span>
                    <span class="c1">// we entered the LoadingState, so let&#39;s do the http request</span>
                    <span class="k">try</span> <span class="p">{</span>
                        <span class="k">val</span> <span class="py">items</span> <span class="p">=</span> <span class="n">httpClient</span><span class="p">.</span><span class="n">loadItems</span><span class="p">()</span>  <span class="c1">// loadItems() is a suspend function</span>
                        <span class="n">OverrideState</span><span class="p">(</span><span class="n">ShowContentState</span><span class="p">(</span><span class="n">items</span><span class="p">))</span> <span class="c1">// return OverrideState</span>
                    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Throwable</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">OverrideState</span><span class="p">(</span><span class="n">ErrorState</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>There are a some new things like  <code>onEnter</code> and <code>OverrideState</code>. We covered <code>OverrideState</code> in
a <a href="#ChangeState">dedicated section</a>. Let&rsquo;s talk about <code>onEnter</code>:</p>
<ul>
<li><strong><code>onEnter { ... }</code> is running asynchronously in a coroutine</strong>. That means whatever you do inside the <code>onEnter</code> block
  is not blocking anything else. You can totally run here long-running and expensive calls (like doing a http request).</li>
<li><strong><code>onEnter { ... }</code> expects a lambda (or function) with the following
  signature: <code>onEnter( (State) -&gt; ChangeState&lt;State&gt; )</code></strong>: <code>OverrideState</code> extends from <code>ChangeState</code>.</li>
<li><strong>The execution of the <code>onEnter { ... }</code> is canceled as soon as state condition specified in the surrounding <code>inState</code>
  doesn&rsquo;t hold anymore (i.e. state has been changes by something else).</strong></li>
</ul>
<h3 id="onaction">on<code>&lt;Action&gt;</code><a class="headerlink" href="#onaction" title="Permanent link">&para;</a></h3>
<p>How do we deal with external user input like clicks in FlowRedux? This is what Actions are for. In FlowRedux DSL you can
react on Actions by using a <code>on&lt;MyAction&gt;{ ... }</code> block.</p>
<p>In our example we want to retry loading if we are in <code>ErrorState</code> and the user clicks on a retry button. Clicking on
that button dispatches a <code>RetryLoadingAction</code> to our state machine. Let&rsquo;s extend our FlowReduxStateMachine to react on
such an action if the current state is <code>ErrorState</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyStateMachine</span><span class="p">(</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">httpClient</span><span class="p">:</span> <span class="n">HttpClient</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">FlowReduxStateMachine</span><span class="p">&lt;</span><span class="n">State</span><span class="p">,</span> <span class="n">Action</span><span class="p">&gt;(</span><span class="n">initialState</span> <span class="p">=</span> <span class="n">LoadingState</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">init</span> <span class="p">{</span>
        <span class="n">spec</span> <span class="p">{</span>
            <span class="n">inState</span><span class="p">&lt;</span><span class="n">LoadingState</span><span class="p">&gt;</span> <span class="p">{</span>
                <span class="n">onEnter</span> <span class="p">{</span> <span class="n">stateSnapshot</span><span class="p">:</span> <span class="n">LoadingState</span> <span class="p">-&gt;</span>
                    <span class="c1">// we entered the LoadingState, so let&#39;s do the http request</span>
                    <span class="k">try</span> <span class="p">{</span>
                        <span class="k">val</span> <span class="py">items</span> <span class="p">=</span> <span class="n">httpClient</span><span class="p">.</span><span class="n">loadItems</span><span class="p">()</span>
                        <span class="n">OverrideState</span><span class="p">(</span><span class="n">ShowContentState</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
                    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Throwable</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">OverrideState</span><span class="p">(</span><span class="n">ErrorState</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="c1">// let&#39;s add a new inState{...} with an on{...} block</span>
            <span class="n">inState</span><span class="p">&lt;</span><span class="n">ErrorState</span><span class="p">&gt;</span> <span class="p">{</span>
                <span class="n">on</span><span class="p">&lt;</span><span class="n">RetryLoadingAction</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">action</span><span class="p">:</span> <span class="n">RetryLoadingAction</span><span class="p">,</span> <span class="n">stateSnapshot</span><span class="p">:</span> <span class="n">ErrorState</span> <span class="p">-&gt;</span>
                    <span class="c1">// This block triggers if we are in ErrorState </span>
                    <span class="c1">// RetryLoadingAction has been dispatched to this state machine.</span>
                    <span class="c1">// In that case we transition to LoadingState which then starts the http</span>
                    <span class="c1">// request to load items again as the inState&lt;LoadingState&gt; + onEnter { ... } triggers</span>

                    <span class="n">OverrideState</span><span class="p">(</span><span class="n">LoadingState</span><span class="p">)</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>A <code>on { ... }</code> block gets 3 parameters:  <code>action</code> which is the actual instance of the <code>Action</code> that triggered this block
and <code>stateSnapshot</code> which is a snapshot of the current state.
<code>on { ... }</code> is actually pretty similar to <code>onEnter {...}</code> just with a different &ldquo;trigger&rdquo; (action vs. entering a state)
. Furthermore, <code>on { ... }</code> has the same characteristics as <code>onEnter { ... }</code>:</p>
<ul>
<li><strong><code>on { ... }</code> is running asynchronously in a coroutine</strong>. That means whatever you do inside the <code>on</code> block is not
  blocking anything else. You can totally run here long-running and expensive calls (like doing a http request).</li>
<li><strong><code>on { ... }</code> expects a lambda (or function) with the following
  signature: <code>(action : Action , stateSnapshot : State) -&gt; ChangeState&lt;State&gt;</code></strong>.</li>
<li><strong>The execution of the <code>on { ... }</code> is canceled as soon as state condition specified in the surrounding <code>inState</code>
  doesn&rsquo;t hold anymore (i.e. state has been changes by something else).</strong></li>
</ul>
<h3 id="collectwhileinstate">collectWhileInState()<a class="headerlink" href="#collectwhileinstate" title="Permanent link">&para;</a></h3>
<p>This one is useful if you want to collect a <code>Flow</code> only while being exactly in that state. To give a concrete example
how this is useful let&rsquo;s extend our example from above. Let&rsquo;s say whenever our state machine is in <code>ErrorState</code> we want
to retry loading the items after 3 seconds in <code>ErrorState</code> or anytime before the 3 seconds have elapsed if the user
clicks the retry button. Furthermore the 3 seconds countdown timer should be displayed in our app:</p>
<p>To implement this let&rsquo;s first extend our <code>ErrorState</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">data</span> <span class="k">class</span> <span class="nc">ErrorState</span><span class="p">(</span>
    <span class="k">val</span> <span class="py">cause</span><span class="p">:</span> <span class="n">Throwable</span><span class="p">,</span>
    <span class="k">val</span> <span class="py">countdown</span><span class="p">:</span> <span class="n">Int</span>    <span class="c1">// This value is decreased from 3 then 2 then 1 and represents the countdown value.</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">State</span><span class="p">()</span>
</code></pre></div>

<p>Now let&rsquo;s add some countdown capabilities to our state machine by using <code>collectWhileInState()</code>:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyStateMachine</span><span class="p">(</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">httpClient</span><span class="p">:</span> <span class="n">HttpClient</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">FlowReduxStateMachine</span><span class="p">&lt;</span><span class="n">State</span><span class="p">,</span> <span class="n">Action</span><span class="p">&gt;(</span><span class="n">initialState</span> <span class="p">=</span> <span class="n">LoadingState</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">init</span> <span class="p">{</span>
        <span class="n">spec</span> <span class="p">{</span>
            <span class="n">inState</span><span class="p">&lt;</span><span class="n">LoadingState</span><span class="p">&gt;</span> <span class="p">{</span>
                <span class="n">inState</span><span class="p">&lt;</span><span class="n">LoadingState</span><span class="p">&gt;</span> <span class="p">{</span>
                    <span class="n">onEnter</span> <span class="p">{</span> <span class="n">stateSnapshot</span><span class="p">:</span> <span class="n">LoadingState</span> <span class="p">-&gt;</span>
                        <span class="c1">// we entered the LoadingState, so let&#39;s do the http request</span>
                        <span class="k">try</span> <span class="p">{</span>
                            <span class="k">val</span> <span class="py">items</span> <span class="p">=</span> <span class="n">httpClient</span><span class="p">.</span><span class="n">loadItems</span><span class="p">()</span>
                            <span class="n">OverrideState</span><span class="p">(</span><span class="n">ShowContentState</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
                        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Throwable</span><span class="p">)</span> <span class="p">{</span>
                            <span class="n">OverrideState</span><span class="p">(</span><span class="n">ErrorState</span><span class="p">(</span><span class="n">t</span><span class="p">))</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>

                <span class="c1">// let&#39;s add a new inState{...} with an on{...} block</span>
                <span class="n">inState</span><span class="p">&lt;</span><span class="n">ErrorState</span><span class="p">&gt;</span> <span class="p">{</span>
                    <span class="n">on</span><span class="p">&lt;</span><span class="n">RetryLoadingAction</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">action</span><span class="p">:</span> <span class="n">RetryLoadingAction</span><span class="p">,</span> <span class="n">stateSnapshot</span><span class="p">:</span> <span class="n">ErrorState</span> <span class="p">-&gt;</span>
                        <span class="n">OverrideState</span><span class="p">(</span><span class="n">LoadingState</span><span class="p">)</span>
                    <span class="p">}</span>

                    <span class="n">collectWhileInState</span><span class="p">(</span><span class="n">timerThatEmitsEverySecond</span><span class="p">())</span> <span class="p">{</span> <span class="n">value</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">stateSnapshot</span><span class="p">:</span> <span class="n">ErrorState</span> <span class="p">-&gt;</span>
                        <span class="c1">// This block triggers every time the timer emits</span>
                        <span class="c1">// which happens every second</span>
                        <span class="n">MutateState</span><span class="p">&lt;</span><span class="n">ErrorState</span><span class="p">,</span> <span class="n">State</span><span class="p">&gt;</span> <span class="p">{</span> <span class="c1">// in this block, this references ErrorState </span>
                            <span class="k">if</span> <span class="p">(</span><span class="n">countdown</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>   <span class="c1">// is the same as this.countdown references ErrorState</span>
                                <span class="n">copy</span><span class="p">(</span><span class="n">countdown</span> <span class="p">=</span> <span class="n">countdown</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span> <span class="c1">//  decrease the countdown by 1 second</span>
                            <span class="k">else</span>
                                <span class="n">LoadingState</span> <span class="c1">// transition to the LoadingState</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">timerThatEmitsEverySecond</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
        <span class="k">var</span> <span class="py">timeElapsed</span> <span class="p">=</span> <span class="m">0</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">isActive</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// is Flow still active?</span>
            <span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>     <span class="c1">// wait 1 second</span>
            <span class="n">timeElapsed</span><span class="p">++</span>
            <span class="n">emit</span><span class="p">(</span><span class="n">timeElapsed</span><span class="p">)</span> <span class="c1">// Flow Emits value</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Let&rsquo;s look at the source code above step by step. Whenever we are in <code>LoadingState</code> and an error occurs while loading
the items we go into
<code>ErrorState</code>. Nothing has changes from previous code snipped. What is new is that <code>ErrorState</code> contains an additional
field  <code>countdown</code> which we set on transitioning from <code>LoadingState</code> to <code>ErrorState(countdown = 3)</code> (means 3 seconds
left).</p>
<p>We extend <code>inState&lt;ErrorState&gt; { ... }</code> block and add a <code>collectWhileInState(timer)</code>.
<code>timer</code> is a <code>Flow&lt;Int&gt;</code> that emits a new (incremented) number every second.
<code>collectWhileInState(timer)</code> calls <code>.collect {...}</code> on the flow passed as parameter and executes the block with the
parameters <code>value</code>
every time <code>timer</code> emits a new value. In other words: instead of calling <code>timer.collect { ... }</code> you
call <code>collectWhileInState(timer) { ... }</code> to collect the Flow&rsquo;s values as long as the state machine is in that state.</p>
<p>The passed Flow (in our case the timer) is automatically canceled once the state machine transitioned from
<code>ErrorState</code> into another state. This happens either when the user clicks on the retry button and which
triggers <code>on&lt;RetryLoadingAction&gt;</code> which causes a state transition to <code>LoadingState</code> or when 3 seconds have elapsed
because then the defined <code>MutateState</code> causes a transitions to <code>LoadingState</code>.</p>
<h2 id="custom-condition-for-instate">Custom condition for inState<a class="headerlink" href="#custom-condition-for-instate" title="Permanent link">&para;</a></h2>
<p>We already covered <code>inState&lt;State&gt;</code> that builds upon the recommended best practice that every State in your state
machine is expressed us it&rsquo;s own type in Kotlin. Again, this is a best practice and the recommended way.</p>
<p>Sometimes, however, you need a bit more flexibility then just relaying on type. For that use case you can
use <code>inStateWithCondition(isInState: (State) -&gt; Boolean)</code>.</p>
<p>Example: One could have also modeled the state for our example above as the following:</p>
<div class="highlight"><pre><span></span><code><span class="c1">// TO MODEL YOUR STATE LIKE THIS IS NOT BEST PRACTICE! Use sealed class instead.</span>
<span class="k">data</span> <span class="k">class</span> <span class="nc">State</span><span class="p">(</span>
    <span class="k">val</span> <span class="py">loading</span><span class="p">:</span> <span class="n">Boolean</span><span class="p">,</span> <span class="c1">// true means loading, false means not loading</span>
    <span class="k">val</span> <span class="py">items</span><span class="p">:</span> <span class="n">List</span><span class="p">&lt;</span><span class="n">Items</span><span class="p">&gt;,</span> <span class="c1">// empty list if no items loaded yet</span>
    <span class="k">val</span> <span class="py">error</span><span class="p">:</span> <span class="n">Throwable</span><span class="p">?,</span> <span class="c1">// if not null we are in error state</span>
    <span class="k">val</span> <span class="py">errorCountDown</span><span class="p">:</span> <span class="n">Int</span><span class="p">?</span> <span class="c1">// the seconds for the error countdown</span>
<span class="p">)</span>
</code></pre></div>

<p><strong>AGAIN, the example shown above is not the recommended way. We strongly recommend to use sealed classes instead to
model state as shown at the beginning of this document.</strong></p>
<p>We just do this for demo purpose to demonstrate a way how to customize <code>inState</code>. Given the state from above, what we
can do now with our DSL is the following:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyStateMachine</span><span class="p">(</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">httpClient</span><span class="p">:</span> <span class="n">HttpClient</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">FlowReduxStateMachine</span><span class="p">&lt;</span><span class="n">State</span><span class="p">,</span> <span class="n">Action</span><span class="p">&gt;(</span>
    <span class="n">initialState</span> <span class="p">=</span> <span class="n">State</span><span class="p">(</span>
        <span class="n">loading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
        <span class="n">items</span> <span class="p">=</span> <span class="n">emptyList</span><span class="p">(),</span>
        <span class="n">error</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
        <span class="n">errorCountDown</span> <span class="p">=</span> <span class="k">null</span>
    <span class="p">)</span>
<span class="p">)</span> <span class="p">{</span>

    <span class="n">init</span> <span class="p">{</span>
        <span class="n">spec</span> <span class="p">{</span>
            <span class="n">inStateWithCondition</span><span class="p">(</span><span class="n">isInState</span> <span class="p">=</span> <span class="p">{</span> <span class="n">state</span> <span class="p">-&gt;</span> <span class="n">state</span><span class="p">.</span><span class="n">loading</span> <span class="p">==</span> <span class="k">true</span> <span class="p">})</span> <span class="p">{</span>
                <span class="n">onEnter</span> <span class="p">{</span> <span class="n">stateSnapshot</span><span class="p">:</span> <span class="n">State</span> <span class="p">-&gt;</span>
                    <span class="c1">// we entered the LoadingState, so let&#39;s do the http request</span>
                    <span class="k">try</span> <span class="p">{</span>
                        <span class="k">val</span> <span class="py">items</span> <span class="p">=</span> <span class="n">httpClient</span><span class="p">.</span><span class="n">loadItems</span><span class="p">()</span>
                        <span class="n">OverrideState</span><span class="p">(</span>
                            <span class="n">State</span><span class="p">(</span><span class="n">loading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">items</span> <span class="p">=</span> <span class="n">items</span><span class="p">,</span> <span class="n">error</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span> <span class="n">errorCountdown</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
                        <span class="p">)</span>
                    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Throwable</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">OverrideState</span><span class="p">(</span>
                            <span class="n">State</span><span class="p">(</span><span class="n">loading</span> <span class="p">=</span> <span class="k">false</span><span class="p">,</span> <span class="n">items</span> <span class="p">=</span> <span class="n">emptyList</span><span class="p">(),</span> <span class="n">error</span> <span class="p">=</span> <span class="n">t</span><span class="p">,</span> <span class="n">errorCountdown</span> <span class="p">=</span> <span class="m">3</span><span class="p">)</span>
                        <span class="p">)</span> <span class="c1">// Countdown starts with 3 seconds</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">inStateWithCondition</span><span class="p">(</span><span class="n">isInState</span> <span class="p">=</span> <span class="p">{</span> <span class="n">state</span> <span class="p">-&gt;</span> <span class="n">state</span><span class="p">.</span><span class="n">error</span> <span class="p">!=</span> <span class="k">null</span> <span class="p">})</span> <span class="p">{</span>
                <span class="n">on</span><span class="p">&lt;</span><span class="n">RetryLoadingAction</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">action</span><span class="p">,</span> <span class="n">stateSnapshot</span> <span class="p">-&gt;</span>
                    <span class="n">OverrideState</span><span class="p">(</span>
                        <span class="n">State</span><span class="p">(</span><span class="n">loading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span> <span class="n">items</span> <span class="p">=</span> <span class="n">emptyList</span><span class="p">(),</span> <span class="n">error</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span> <span class="n">errorCountdown</span> <span class="p">=</span> <span class="k">null</span><span class="p">)</span>
                    <span class="p">)</span>
                <span class="p">}</span>

                <span class="n">collectWhileInState</span><span class="p">(</span><span class="n">timerThatEmitsEverySecond</span><span class="p">())</span> <span class="p">{</span> <span class="n">value</span><span class="p">,</span> <span class="n">stateSnapshot</span> <span class="p">-&gt;</span>
                    <span class="n">MutateState</span><span class="p">&lt;</span><span class="n">State</span><span class="p">,</span> <span class="n">State</span><span class="p">&gt;</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="n">errorCountdown</span><span class="o">!!</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span>
                            <span class="n">copy</span><span class="p">(</span><span class="n">errorCountdown</span> <span class="p">=</span> <span class="n">errorCountdown</span><span class="o">!!</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span> <span class="c1">//  decrease the countdown by 1 second</span>
                        <span class="k">else</span>
                            <span class="n">State</span><span class="p">(</span>
                                <span class="n">loading</span> <span class="p">=</span> <span class="k">true</span><span class="p">,</span>
                                <span class="n">items</span> <span class="p">=</span> <span class="n">emptyList</span><span class="p">(),</span>
                                <span class="n">error</span> <span class="p">=</span> <span class="k">null</span><span class="p">,</span>
                                <span class="n">errorCountdown</span> <span class="p">=</span> <span class="k">null</span>
                            <span class="p">)</span> <span class="c1">// transition to the LoadingState</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Instead of <code>inState&lt;State&gt; { ... }</code> we can use <code>inStateWithCondition</code> that instead of generics take a lambda as
parameter that looks like <code>(State) -&gt; Boolean</code> so that. If that lambda returns <code>true</code> it means we are in that state,
otherwise not (returning false). The rest still remains the same. You can use <code>onEnter</code>, <code>on&lt;Action&gt;</code>
and <code>collectWhileInState</code> the exact way as you already know. However, since <code>inStateWithCondition</code> has no generics,
FlowRedux cannot infer types in <code>onEnter</code>, <code>on</code>, etc.</p>
<h2 id="collectwhileinanystate">collectWhileInAnyState()<a class="headerlink" href="#collectwhileinanystate" title="Permanent link">&para;</a></h2>
<p>If for whatever reason you want to trigger a state change out of  <code>inState&lt;&gt;</code>, <code>onEnter { ... }</code>, <code>on&lt;Action&gt;</code>
or <code>collectWhileInState { ... }</code> by observing a <code>Flow</code> then <code>collectWhileInAnyState</code> is what you are looking for:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyStateMachine</span><span class="p">(</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">httpClient</span><span class="p">:</span> <span class="n">HttpClient</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">FlowReduxStateMachine</span><span class="p">&lt;</span><span class="n">State</span><span class="p">,</span> <span class="n">Action</span><span class="p">&gt;(</span><span class="n">initialState</span> <span class="p">=</span> <span class="n">LoadingState</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">init</span> <span class="p">{</span>
        <span class="n">spec</span> <span class="p">{</span>
            <span class="n">inState</span><span class="p">&lt;</span><span class="n">LoadingState</span><span class="p">&gt;</span> <span class="p">{</span>
                <span class="n">onEnter</span> <span class="p">{</span> <span class="n">stateSnapshot</span><span class="p">:</span> <span class="n">LoadingState</span> <span class="p">-&gt;</span>
                    <span class="p">...</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">inState</span><span class="p">&lt;</span><span class="n">ErrorState</span><span class="p">&gt;</span> <span class="p">{</span>
                <span class="n">on</span><span class="p">&lt;</span><span class="n">RetryLoadingAction</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">action</span><span class="p">:</span> <span class="n">RetryLoadingAction</span><span class="p">,</span> <span class="n">stateSnapshot</span><span class="p">:</span> <span class="n">ErrorState</span> <span class="p">-&gt;</span>
                    <span class="p">...</span>
                <span class="p">}</span>

                <span class="n">collectWhileInState</span><span class="p">(</span><span class="n">timer</span><span class="p">)</span> <span class="p">{</span> <span class="n">value</span><span class="p">,</span> <span class="n">stateSnapshot</span><span class="p">:</span> <span class="n">ErrorState</span> <span class="p">-&gt;</span>
                    <span class="p">...</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="k">val</span> <span class="py">aFlow</span><span class="p">:</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flowOf</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">4</span><span class="p">)</span>
            <span class="n">collectWhileInAnyState</span><span class="p">(</span><span class="n">aFlow</span><span class="p">)</span> <span class="p">{</span> <span class="n">value</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span> <span class="n">stateSnapshot</span><span class="p">:</span> <span class="n">State</span> <span class="p">-&gt;</span>
                <span class="c1">// Will trigger anytime flow emits a value</span>
                <span class="p">...</span>
            <span class="p">}</span>

            <span class="n">collectWhileInAnyState</span><span class="p">(</span><span class="n">anotherFlow</span><span class="p">)</span> <span class="p">{</span> <span class="n">value</span><span class="p">:</span> <span class="n">String</span><span class="p">,</span> <span class="n">stateSnapshot</span><span class="p">:</span> <span class="n">State</span> <span class="p">-&gt;</span>
                <span class="c1">// Will trigger anytime flow emits a value</span>
                <span class="p">...</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p><code>collectWhileInAnyState()</code> is like <code>collectWhileInState()</code> just that it is not bound to the current state
like <code>collectWhileInState()</code> is.
<code>collectWhileInAnyState()</code> will stop collecting the passed in Flow only if the CoroutineScope of the whole
FlowReduxStateMachine gets canceled.</p>
<h2 id="flatmappolicy">FlatMapPolicy<a class="headerlink" href="#flatmappolicy" title="Permanent link">&para;</a></h2>
<p>Have you ever wondered what would happen if you would execute <code>Action</code> very fast 1 after another? For example:</p>
<div class="highlight"><pre><span></span><code><span class="n">spec</span> <span class="p">{</span>
    <span class="n">inState</span><span class="p">&lt;</span><span class="n">FooState</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="n">on</span><span class="p">&lt;</span><span class="n">BarAction</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">action</span><span class="p">,</span> <span class="n">stateSnapshot</span> <span class="p">-&gt;</span>
            <span class="n">delay</span><span class="p">(</span><span class="m">5000</span><span class="p">)</span> <span class="c1">// wait for 5 seconds</span>
            <span class="n">OverrideState</span><span class="p">(</span><span class="n">OtherState</span><span class="p">())</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>The example above shows a problem with async. state machines like FlowRedux:
If our state machine is in <code>FooState</code> and a <code>BarAction</code> got triggered, we wait for 5 seconds and then set the state to
another state. What if while waiting 5 seconds (i.e. let&rsquo;s say after 3 seconds of waiting) another <code>BarAction</code> gets
triggered. That is possible right? With <code>FlatMapPolicy</code> you can specify what should happen in that case. There are three
options to choose from:</p>
<ul>
<li><code>LATEST</code>: This is the default one. It would cancel any previous execution and just run the latest one. In the example
  above it would meanwhile wait 5 seconds another <code>BarAction</code> gets triggered, the first execution of <code>on&lt;BarAction&gt;</code>
  block gets stopped and a new <code>on&lt;BarAction&gt;</code> block starts.</li>
<li><code>MERGE</code>: Choosing this causes all the blocks to continue running but there are no guarantees in which order. For
  example:</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="n">spec</span> <span class="p">{</span>
    <span class="n">inState</span><span class="p">&lt;</span><span class="n">FooState</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="n">on</span><span class="p">&lt;</span><span class="n">BarAction</span><span class="p">&gt;(</span><span class="n">flatMapPolicy</span> <span class="p">=</span> <span class="n">FlapMapPolicy</span><span class="p">.</span><span class="n">MERGE</span><span class="p">)</span> <span class="p">{</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">setState</span> <span class="p">-&gt;</span>
            <span class="n">delay</span><span class="p">(</span><span class="n">randomInt</span><span class="p">())</span> <span class="c1">// wait for some random time</span>
            <span class="n">setState</span> <span class="p">{</span> <span class="n">OtherState</span> <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Let&rsquo;s assume that we trigger two times <code>BarAction</code>. We use random amount of seconds for waiting. Since we
use <code>MERGE</code> <code>on&lt;BarAction&gt;</code> block gets executed 2 times without canceling the previous one (that is the difference
to <code>LATEST</code>). Moreover, <code>MERGE</code> doesn&rsquo;t make any promise on order of execution of the block (see <code>CONCAT</code> if you need
promises on order). So if <code>on&lt;BarAction&gt;</code> gets executed two times it will run in parallel and the the second execution
could complete before the first execution (because using a random time of waiting).</p>
<ul>
<li><code>CONCAT</code>: In contrast to <code>MERGE</code> and <code>LATEST</code> <code>CONCAT</code> will not run <code>on&lt;BarAction&gt;</code> in parallel and will not cancel
  any previous execution. Instead, <code>CONCAT</code> will preserve the order and execute one block after another.</li>
</ul>
<p>All execution blocks can specify a <code>FlatMapPolicy</code>:</p>
<ul>
<li><code>on&lt;Action&gt;(flatMapPolicy = FlatMapPolicy.LATEST){... }</code></li>
<li><code>onEnter(flatMapPolicy = FlatMapPolicy.LATEST) { ... }</code></li>
<li><code>collectWhileInState(flatMapPolicy = FlatMapPolicy.LATEST) { ... }</code></li>
</ul>
<h2 id="best-practice">Best Practice<a class="headerlink" href="#best-practice" title="Permanent link">&para;</a></h2>
<p>One very important aspect of the DSL is to provide a readable and maintainable way to reason about your state machine.
Let&rsquo; take a look at our example state machine:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyStateMachine</span><span class="p">(</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">httpClient</span><span class="p">:</span> <span class="n">HttpClient</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">FlowReduxStateMachine</span><span class="p">&lt;</span><span class="n">State</span><span class="p">,</span> <span class="n">Action</span><span class="p">&gt;(</span><span class="n">initialState</span> <span class="p">=</span> <span class="n">LoadingState</span><span class="p">)</span> <span class="p">{</span>

    <span class="n">init</span> <span class="p">{</span>
        <span class="n">spec</span> <span class="p">{</span>
            <span class="n">inState</span><span class="p">&lt;</span><span class="n">LoadingState</span><span class="p">&gt;</span> <span class="p">{</span>
                <span class="n">onEnter</span> <span class="p">{</span> <span class="n">stateSnapshot</span> <span class="p">-&gt;</span>
                    <span class="c1">// we entered the LoadingState, so let&#39;s do the http request</span>
                    <span class="k">try</span> <span class="p">{</span>
                        <span class="k">val</span> <span class="py">items</span> <span class="p">=</span> <span class="n">httpClient</span><span class="p">.</span><span class="n">loadItems</span><span class="p">()</span>
                        <span class="n">OverrideState</span><span class="p">(</span><span class="n">ShowContentState</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
                    <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Throwable</span><span class="p">)</span> <span class="p">{</span>
                        <span class="n">OverrideState</span><span class="p">(</span><span class="n">ErrorState</span><span class="p">(</span><span class="n">cause</span> <span class="p">=</span> <span class="n">t</span><span class="p">,</span> <span class="n">countdown</span> <span class="p">=</span> <span class="m">3</span><span class="p">))</span> <span class="c1">// Countdown starts with 3 seconds</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="n">inState</span><span class="p">&lt;</span><span class="n">ErrorState</span><span class="p">&gt;</span> <span class="p">{</span>
                <span class="n">on</span><span class="p">&lt;</span><span class="n">RetryLoadingAction</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">action</span><span class="p">,</span> <span class="n">stateSnapshot</span> <span class="p">-&gt;</span>
                    <span class="n">OverrideState</span><span class="p">(</span><span class="n">LoadingState</span><span class="p">)</span>
                <span class="p">}</span>

                <span class="n">collectWhileInState</span><span class="p">(</span><span class="n">timerThatEmitsEverySecond</span><span class="p">())</span> <span class="p">{</span> <span class="n">value</span><span class="p">,</span> <span class="n">stateSnapshot</span> <span class="p">-&gt;</span>
                    <span class="n">MutateState</span><span class="p">&lt;</span><span class="n">ErrorState</span><span class="p">,</span> <span class="n">State</span><span class="p">&gt;</span> <span class="p">{</span>
                        <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">countdownTimeLeft</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="c1">// this is referencing ErrorState</span>
                            <span class="k">this</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">countdown</span> <span class="p">=</span> <span class="n">countdownTimeLeft</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span>  <span class="c1">//  decrease the countdown by 1 second</span>
                        <span class="k">else</span>
                            <span class="n">LoadingState</span>  <span class="c1">// transition to the LoadingState</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">timerThatEmitsEverySecond</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
        <span class="k">var</span> <span class="py">timeElapsed</span> <span class="p">=</span> <span class="m">0</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">isActive</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// is Flow still active?</span>
            <span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>     <span class="c1">// wait 1 second</span>
            <span class="n">timeElapsed</span><span class="p">++</span>
            <span class="n">emit</span><span class="p">(</span><span class="n">timeElapsed</span><span class="p">)</span> <span class="c1">// Flow Emits value</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>Do you notice something? With more blocks we add the state machine itself gets harder to read, understand and maintain.
What we are aiming for with the DSL is an overview about what the state machine is supposed to do on a high level that
reads like as specification. If you take a look at the example from above, however, you will notice that it isn&rsquo;t easy
to read and get bloated with implementation details.</p>
<h3 id="the-recommended-way">The recommended way<a class="headerlink" href="#the-recommended-way" title="Permanent link">&para;</a></h3>
<p>We recommend keeping the DSL really short, expressive, readable and maintainable. Therefore instead of having
implementation details in your DSL we recommend to use function references instead. Let&rsquo;s refactor the example above to
reflect this idea:</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">MyStateMachine</span><span class="p">(</span>
    <span class="k">private</span> <span class="k">val</span> <span class="py">httpClient</span><span class="p">:</span> <span class="n">HttpClient</span>
<span class="p">)</span> <span class="p">:</span> <span class="n">FlowReduxStateMachine</span><span class="p">&lt;</span><span class="n">State</span><span class="p">,</span> <span class="n">Action</span><span class="p">&gt;(</span><span class="n">initialState</span> <span class="p">=</span> <span class="n">LoadingState</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">//</span>
    <span class="c1">// This is the specification of your state machine. Less implementation details, better readability.</span>
    <span class="c1">//</span>
    <span class="n">init</span> <span class="p">{</span>
        <span class="n">spec</span> <span class="p">{</span>
            <span class="n">inState</span><span class="p">&lt;</span><span class="n">LoadingState</span><span class="p">&gt;</span> <span class="p">{</span>
                <span class="n">onEnter</span><span class="p">(</span><span class="o">::</span><span class="n">loadItemsAndMoveToContentOrErrorState</span><span class="p">)</span>
            <span class="p">}</span>

            <span class="n">inState</span><span class="p">&lt;</span><span class="n">ErrorState</span><span class="p">&gt;</span> <span class="p">{</span>
                <span class="n">on</span><span class="p">&lt;</span><span class="n">RetryLoadingAction</span><span class="p">&gt;</span> <span class="p">{</span> <span class="n">action</span><span class="p">,</span> <span class="n">stateSnapshot</span> <span class="p">-&gt;</span>
                    <span class="c1">// For a single line statement it&#39;s ok to keep the block instead of moving to a function reference</span>
                    <span class="n">OverrideState</span><span class="p">(</span><span class="n">LoadingState</span><span class="p">)</span>
                <span class="p">}</span>

                <span class="n">collectWhileInState</span><span class="p">(</span>
                    <span class="n">timerThatEmitsEverySecond</span><span class="p">(),</span>
                    <span class="o">::</span><span class="n">onSecondElapsedMoveToLoadingStateOrDecrementCountdown</span>
                <span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>


    <span class="c1">//</span>
    <span class="c1">// All the implementation details are in the functions below.</span>
    <span class="c1">//</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">loadItemsAndMoveToContentOrErrorState</span><span class="p">(</span><span class="n">stateSnapshot</span><span class="p">:</span> <span class="n">LoadingState</span><span class="p">):</span> <span class="n">ChangeState</span><span class="p">&lt;</span><span class="n">State</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="k">try</span> <span class="p">{</span>
            <span class="k">val</span> <span class="py">items</span> <span class="p">=</span> <span class="n">httpClient</span><span class="p">.</span><span class="n">loadItems</span><span class="p">()</span>
            <span class="n">OverrideState</span><span class="p">(</span><span class="n">ShowContentState</span><span class="p">(</span><span class="n">items</span><span class="p">))</span>
        <span class="p">}</span> <span class="k">catch</span> <span class="p">(</span><span class="n">t</span><span class="p">:</span> <span class="n">Throwable</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">OverrideState</span><span class="p">(</span><span class="n">ErrorState</span><span class="p">(</span><span class="n">cause</span> <span class="p">=</span> <span class="n">t</span><span class="p">,</span> <span class="n">countdown</span> <span class="p">=</span> <span class="m">3</span><span class="p">))</span> <span class="c1">// Countdown starts with 3 seconds</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">onSecondElapsedMoveToLoadingStateOrDecrementCountdown</span><span class="p">(</span>
        <span class="n">value</span><span class="p">:</span> <span class="n">Int</span><span class="p">,</span>
        <span class="n">stateSnapshot</span><span class="p">:</span> <span class="n">ErrorState</span>
    <span class="p">):</span> <span class="n">ChangeState</span><span class="p">&lt;</span><span class="n">State</span><span class="p">&gt;</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">MutateState</span><span class="p">&lt;</span><span class="n">ErrorState</span><span class="p">,</span> <span class="n">State</span><span class="p">&gt;</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="n">countdownTimeLeft</span> <span class="p">&gt;</span> <span class="m">0</span><span class="p">)</span> <span class="c1">// this is referencing ErrorState</span>
                <span class="k">this</span><span class="p">.</span><span class="n">copy</span><span class="p">(</span><span class="n">countdown</span> <span class="p">=</span> <span class="n">countdownTimeLeft</span> <span class="p">-</span> <span class="m">1</span><span class="p">)</span>  <span class="c1">//  decrease the countdown by 1 second</span>
            <span class="k">else</span>
                <span class="n">LoadingState</span>  <span class="c1">// transition to the LoadingState</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">private</span> <span class="k">fun</span> <span class="nf">timerThatEmitsEverySecond</span><span class="p">():</span> <span class="n">Flow</span><span class="p">&lt;</span><span class="n">Int</span><span class="p">&gt;</span> <span class="p">=</span> <span class="n">flow</span> <span class="p">{</span>
        <span class="k">var</span> <span class="py">timeElapsed</span> <span class="p">=</span> <span class="m">0</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">isActive</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// is Flow still active?</span>
            <span class="n">delay</span><span class="p">(</span><span class="m">1000</span><span class="p">)</span>     <span class="c1">// wait 1 second</span>
            <span class="n">timeElapsed</span><span class="p">++</span>
            <span class="n">emit</span><span class="p">(</span><span class="n">timeElapsed</span><span class="p">)</span> <span class="c1">// Flow Emits value</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>By using function references you can read the DSL better and can zoom in into implementation details anytime you want to
by looking into a function body.</p>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="../contributing/" title="Contributing" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Contributing
              </div>
            </div>
          </a>
        
        
          <a href="../flow_vs_FlowReduxStateMachine/" title="FlowReduxStateMachine vs .reduxStore()" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                FlowReduxStateMachine vs .reduxStore()
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 Freeletics.
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.77e55a48.min.js"></script>
      <script src="../assets/javascripts/bundle.aa3f9871.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: [],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
    
  </body>
</html>